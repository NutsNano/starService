<html>
  <head>
    <meta charset="UTF-8">
    <link href="style.css" rel="stylesheet">
    <title>starService Frontend</title>
  </head>
  <body>
    <button style="background-color: white;color: black; font-size: medium;"
      onclick="clearScreen()">Clear Screen</button>
    <button style="background-color: lightgreen;color: black; font-size: medium;"
      onclick="setColor(constellations,readColor());drawConstellations(constellations)">DRAW ALL</button>
    <button style="background-color: darkblue;color: white; font-size: medium;"
      onclick="constellationButton(readColor())">DRAW CONSTELLATION</button>
    <button style="background-color: darkgreen;color: white; font-size: medium;"
      onclick="setColor(consZodiac,readColor());drawConstellations(consZodiac)">DRAW ZODIAC</button>
    <button id="zoomout" disabled="true" style="background-color: lightgrey;color: grey; font-size: medium;"
      onclick="zoomOut()">ZOOM OUT</button>
    <form>
      <select id="magSelect" size="5" style="background-color: darkred;color: white; font-size: medium;"
        onclick="processMag()">
        <option value="4">Mag  4</option>
        <option value="5">Mag  5</option>
        <option value="6">Mag  6</option>
        <option value="8">Mag  8</option>
        <option value="20">Mag 20</option>
      </select>
      
      <select id="conSelect" size="5" style="background-color: darkblue;color: white; font-size: medium;">
      </select>
      <input type="checkbox" id="type"  value="primary">
        <label for="type" style="color: black">PRIMARY ONLY</label>
      <input type="radio" id="red" name="color" value="red">
        <label for="red" style="color: red">RED</label>
      <input type="radio" id="green" name="color" value="green">
        <label for="green" style="color: green">GREEN</label>
      <input type="radio" id="blue" name="color" value="blue">
        <label for="blue" style="color: blue">BLUE</label>
      <input type="radio" id="orange" name="color" value="orange">
        <label for="orange" style="color: orange">ORANGE</label>
      <input type="radio" id="violet" name="color" value="violet">
        <label for="violet" style="color: violet">VIOLET</label>
      <input type="radio" id="lightgrey" name="color" value="lightgrey">
        <label for="lightgrey" style="color: darkgrey">LIGHTGREY</label>
    </form>
    
    <canvas id="starCanvas" width="1000" height="1000"
        style="border:2px solid #000000; background-color: #FFFFFF;"
        onclick="callbackCanvas(event.offsetX,event.offsetY,event.altKey)"
        onmousedown="callbackCanvasDown(event.offsetX,event.offsetY,event.altKey)"
        onmouseup="callbackCanvasUp(event.offsetX,event.offsetY,event.altKey)">
    </canvas>
    <div id="responseSession">mein text</div>
  </body>

  <body>
    <script>
      var url = "http://localhost:3000/starService";
      var sessionId = "";
      var sessionBody = {
        UUID: "1234",
        owner: "Peter",
        maxResult: 10000,
        minMag: 5
      }
      var constellations = [];
      var zodiac = ["Ari","Tau","Gem","Cnc","Leo","Vir","Lib","Sco","Sgr","Cap","Aqr","Psc"];
      var consZodiac = [];
      for( var i=0; i<zodiac.length; i++ )
        consZodiac.push( {name: zodiac[i], color: "white", lastColor: "empty"} );
      vpStack = [];
      var vp = {
        viewport: {x:1000,y:1000},
        scale: 1,
        center: {x:0,y:0},
        domain: {x:2,y:2},
        dmin: {x:-1,y:-1},
        dmax: {x:1,y:1},
        ddiff: {x:2,y:2}
      };
      var zstart = {x:-1,y:1};
      var zend = {x:1,y:-1};
     
      getConstellations();
      createSession();
      
      function vport( d ){
        return { x:(d.x-vp.dmin.x)*vp.viewport.x/vp.ddiff.x, y:vp.viewport.y - ((d.y-vp.dmin.y)*vp.viewport.y/vp.ddiff.y) };
      }

      function dom( v ){
        return { x:(v.x*vp.ddiff.x/vp.viewport.x)+vp.dmin.x, y:((v.y-vp.viewport.y)*vp.ddiff.y/(-vp.viewport.y))+vp.dmin.y };
      }


      // fill the selector widget with the constellations
      function fillSelector( cons ) {
        var sel = document.getElementById("conSelect");
        for( var i=0; i<cons.length; i++ ){
            var opt = document.createElement("OPTION");
            opt.value = cons[i].name;
            opt.innerText = cons[i].name;
            sel.options.add(opt);
        }
      }

      // sort the constellations array
      function sortConstellations( cons ){
        for( var i=0; i<cons.length; i++ )
          for( var j=i; j<cons.length; j++ ){
            if( cons[i].name>cons[j].name ){
                var tmp = cons[i];
                cons[i] = cons[j];
                cons[j] = tmp;
            }
          }
        return cons;
      }

      // get constellations from starService and prepare selector
      function getConstellations(){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", url+"/1/constellations", true);
        xmlhttp.onreadystatechange = function() {
          if(xmlhttp.readyState ===4 && xmlhttp.status ===200 || xmlhttp.status ===201 || xmlhttp.status ===204){
            var conNames = JSON.parse(xmlhttp.responseText);
            var cons = [];
            for( var i=0; i<conNames.length; i++ )
              cons.push( {name: conNames[i], color: "white", lastColor: "empty"} );
            constellations = sortConstellations( cons );
            fillSelector( constellations );
          }
        };
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send();
      }        

      // create new starService session (or open existing session)
      function createSession(){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", url, true);
        xmlhttp.onreadystatechange = function() {
          if(xmlhttp.readyState ===4 && xmlhttp.status ===200 || xmlhttp.status ===201 || xmlhttp.status ===204){
            var responseInfo = xmlhttp.responseText;
            if( responseInfo != '' )
              document.getElementById("responseSession").innerHTML = responseInfo;
            sessionId = JSON.parse(responseInfo);
          }
        };
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send(JSON.stringify(sessionBody));
      }
      
      // set color for all cons(tellations) in the global constellations
      function setColor( cons, color ){
        cons.forEach( (e) => {
          var index = constellations.findIndex( (v) => (v.name == e.name) );
          if( index !== -1 ){
            constellations[index].lastColor = "empty";
            constellations[index].color = color;
          }
        });
      }

      // switch color for all cons(tellations) in the global constellations
      function switchColor( cons, color ){
        cons.forEach( (e) => {
          var index = constellations.findIndex( (v) => (v.name == e.name) );
          if( index !== -1 ){
            if( constellations[index].lastColor === "empty" ){
              constellations[index].lastColor = constellations[index].color;
              constellations[index].color = color;
            }else{
              constellations[index].color = constellations[index].lastColor;
              constellations[index].lastColor = "empty";
            }
          }
        });
      }

      // draw stars on canvas using color
      function drawStars( stars, color ) {
        var canvas = document.getElementById("starCanvas");
        var ctx = canvas.getContext("2d");
        // var canvasHalf = canvasWidth/2;
        ctx.fillStyle = color;
        stars.forEach((v) => {
          var vprt = vport( {x:v.x,y:v.y} );
          ctx.beginPath();
          if( Number(v.mag) < 3 ){
            if( color == "white" )
              ctx.arc(vprt.x,vprt.y,3,0,2*Math.PI);
            else
              ctx.arc(vprt.x,vprt.y,2,0,2*Math.PI);
          }else{
            if( color == "white" )
              ctx.arc(vprt.x,vprt.y,2,0,2*Math.PI);
            else
              ctx.arc(vprt.x,vprt.y,1,0,2*Math.PI);
          }
          ctx.fill();
        });
      }

      // get stars of conName from starService and draw them
      function drawConstellation( conName, color ){
        var xmlhttp = new XMLHttpRequest();
        var uri = url+"/"+sessionId+"/star?constellation="+conName;
        var primaryChecked = document.getElementById("type").checked;
        if( primaryChecked )
          uri = uri + "&type=primary";
        xmlhttp.open("GET", uri, true);
        xmlhttp.onreadystatechange = function() {
          if(xmlhttp.readyState ===4 && xmlhttp.status ===200 || xmlhttp.status ===201 || xmlhttp.status ===204){
            var responseInfo = xmlhttp.responseText;
            var stars = JSON.parse(responseInfo);
            drawStars( stars, "white" );
            drawStars( stars, color );
          }
        };
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send();
      }
      
      // draw all elements in cons(tellations) array using their (global) color
      function drawConstellations( cons ){
        cons.forEach( (e) => {
          var index = constellations.findIndex( (v) => (v.name === e.name) );
          if( index !== -1 ){
            //drawConstellation( constellations[index].name, "white" );
            drawConstellation( constellations[index].name, constellations[index].color );
          }
        });
      }

      // draw all constellations with a valid color
      function drawActiveConstellations(){
        constellations.forEach( (e) => {
          if( e.color !== "white" ){
            drawConstellation( e.name, e.color );
          }
        });
      }

      // callback function for draw constellation button
      function constellationButton( color ){
        var sel = document.getElementById("conSelect");
        setColor( [{name:sel.value}], color );
        drawConstellation( sel.value, color );
      }

      // change magnitude threshold within starService session
      function changeMag( newMag ){
        var body = {minMag:newMag, maxResult:10000};
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("PUT", url+"/"+sessionId, true);
        xmlhttp.onreadystatechange = function() {
          if(xmlhttp.readyState ===4 && xmlhttp.status ===200 || xmlhttp.status ===201 || xmlhttp.status ===204){
            var responseInfo = xmlhttp.responseText;
            if( responseInfo != '' )
              document.getElementById("responseSession").innerHTML = responseInfo;
          }
        };
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send(JSON.stringify( body ));
      }
      
      // read mag from selection and set it using changeMag
      function processMag(){
        var sel = document.getElementById("magSelect");
        changeMag( sel.value );
      }

      function readColor(){
        var color = "yellow";
        if( document.getElementById("red").checked ) color="red";
        if( document.getElementById("green").checked ) color="green";
        if( document.getElementById("blue").checked ) color="blue";
        if( document.getElementById("orange").checked ) color="orange";
        if( document.getElementById("violet").checked ) color="violet";
        if( document.getElementById("lightgrey").checked ) color="lightgrey";
        return color;
      }

      function callbackCanvas( xCanvas, yCanvas, alt ) {
        if( alt ) return;
        var tmp = dom( {x:xCanvas, y:yCanvas});
        var uri = url+"/"+sessionId+"/find?x="+String(tmp.x)+"&y="+String(tmp.y);
 
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", uri, true);
        xmlhttp.onreadystatechange = function() {
          if(xmlhttp.readyState ===4 && xmlhttp.status ===200 || xmlhttp.status ===201 || xmlhttp.status ===204){
            var responseInfo = xmlhttp.responseText;
            var res = JSON.parse( responseInfo );
            if( responseInfo !== '' )
              document.getElementById("responseSession").innerHTML = responseInfo;
              switchColor( [{name:res.con}], readColor() );
            drawConstellations( [{name:res.con}] );
          }
        };
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send();
      }

      function callbackCanvasDown( xCanvas, yCanvas, alt ) {
        if( !alt ) return;
        zstart = dom( {x:xCanvas, y:yCanvas} );
        // var canvasHalf = canvasWidth/2;
        // var x = (xCanvas-canvasHalf)/canvasHalf;
        // var y = (yCanvas-canvasHalf)/(-canvasHalf);
        document.getElementById("responseSession").innerHTML = "DOWN x="+String(Math.floor(1000*zstart.x)/1000)+" y="+String(Math.floor(1000*zstart.y)/1000);
      }

      function callbackCanvasUp( xCanvas, yCanvas, alt ) {
        if( !alt ) return;
        zend = dom( {x:xCanvas, y:yCanvas} );
        document.getElementById("responseSession").innerHTML = "UP x="+String(Math.floor(1000*zend.x)/1000)+" y="+String(Math.floor(1000*zend.y)/1000);
        if( zstart.x === zend.x || zstart.y === zend.y ) return;
        
        var zminx = ( zstart.x < zend.x ? zstart.x : zend.x );
        var zminy = ( zstart.y < zend.y ? zstart.y : zend.y );
        var zmaxx = ( zstart.x > zend.x ? zstart.x : zend.x );
        var zmaxy = ( zstart.y > zend.y ? zstart.y : zend.y );
        var zdiffx = zmaxx-zminx;
        var zdiffy = zmaxy-zminy;
        var centerNew = {x:(zend.x+zstart.x)/2, y:(zend.y+zstart.y)/2};
        var scaleNew = ( zdiffx >= zdiffy ? vp.domain.x/zdiffx : vp.domain.y/zdiffy );
        var dminNew = {x:centerNew.x-(vp.domain.x/(2*scaleNew)), y:centerNew.y-(vp.domain.y/(2*scaleNew))}; 
        var dmaxNew = {x:centerNew.x+(vp.domain.x/(2*scaleNew)), y:centerNew.y+(vp.domain.y/(2*scaleNew))};
        var ddiffNew = {x:dmaxNew.x-dminNew.x, y: dmaxNew.y-dminNew.y};
        vpStack.push( vp );
        document.getElementById("zoomout").disabled = false;
        document.getElementById("zoomout").style.color = "white";
        document.getElementById("zoomout").style.backgroundColor = "darkviolet";
        vp = {};
        vp = {
          viewport: {x:1000,y:1000},
          domain: {x:2,y:2},
          center: centerNew,
          scale: scaleNew,
          dmin: dminNew,
          dmax: dmaxNew,
          ddiff: ddiffNew
        };
        console.log( vp );
        zstart = {x:-1,y:1};
        zend = {x:1,y:-1};
        
        var canvas = document.getElementById("starCanvas");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,vp.viewport.x,vp.viewport.y);
        ctx.fill();

        drawActiveConstellations();
      }

      // set zoom to half the former value
      function zoomOut(){
        if( vpStack.length === 0 )
          return;
        vp = vpStack.pop();
        if( vpStack.length === 0 ){
          document.getElementById("zoomout").disabled = true;
          document.getElementById("zoomout").style.color = "grey";
          document.getElementById("zoomout").style.backgroundColor = "lightgrey";
        }
        var canvas = document.getElementById("starCanvas");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,vp.viewport.x,vp.viewport.y);
        ctx.fill();

        drawActiveConstellations();
        
      }

      // clear canvas screen
      function clearScreen(){
        var canvas = document.getElementById("starCanvas");
        var ctx = canvas.getContext("2d");
        // var canvasHalf = canvasWidth/2;
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,vp.viewport.x,vp.viewport.y);
        ctx.fill();
        constellations.forEach( (v) => {
            v.color = "white";
            v.lastColor = "empty";
        });
      }
    </script>
  </body>  
</html>